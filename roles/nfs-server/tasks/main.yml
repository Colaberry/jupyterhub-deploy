---
- name: install mdadm and nfs packages
  apt: update_cache=yes cache_valid_time=600 name=mdadm,nfs-kernel-server,nfs-common state=latest
  sudo: yes
  tags:
    - nfs

- name: run the lsi-cards script
  script: lsi-cards {{ ansible_fqdn }} /var/lib/docker creates=/etc/{{ ansible_fqdn }}.raid-setup
  sudo: yes
  tags:
    - nfs

- name: install /etc/exports
  file: src=exports dest=/etc/exports mode=0644
  sudo: yes
  register: exportconf
  tags:
    - nfs

- name: restart nfs
  service: name=nfs-kernel-server state=restarted
  sudo: yes
  when: exportconf | changed
  tags:
    - nfs

- name: restart nfs
  service: name=idmapd state=restarted
  sudo: yes
  when: exportconf | changed
  tags:
    - nfs

- name: create /var/lib/docker/export
  file: path=/var/lib/docker/export state=directory
  sudo: yes
  tags:
    - nfs

- name: create /var/lib/docker/export/home
  file: path=/var/lib/docker/export/home state=directory
  sudo: yes
  tags:
    - nfs

- name: create /home
  file: path=/home state=directory
  sudo: yes
  tags:
    - nfs

- name: mount /var/lib/docker/export/home as /home
  shell: mount --bind /home /var/lib/docker/export/home
  sudo: yes
  tags:
    - nfs
